<!DOCTYPE html>
<html lang="it">
<head>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Sito web e portofolio di Andrea Rufo, full stack web developer. Programmazione di siti web e applicazioni. Specializzato in Larave, Vue, PWA, WordPress e webdesign.">

<title>Normalizzare un post di WordPress con i suoi meta</title>

<link rel="canonical" href="https://www.andrearufo.it/articoli/2019/11/10/normalizzare-un-post-di-wordpress-con-i-suoi-meta">
<link rel="icon" type="image/svg+xml" href="https://www.andrearufo.it/assets/images/favicon.svg">
<link rel="stylesheet" href="/assets/build/css/main.css?id=38e1f6bd06fbdaec4092">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/color-brewer.min.css" integrity="sha512-SJm3cAu//Nn6+cv90D0Ue8ArsnjDlszVGE3o/0JX55VOd9/KVbSGTegrZhyNK6ttKMeLbR14ezeGWyBUmF1Aww==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js" integrity="sha512-Pbb8o120v5/hN/a6LjF4N4Lxou+xYZ0QcVF8J6TWhBbHmctQWd8O6xTDmHpE/91OjPzCk4JRoiJsexHYg4SotQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>hljs.highlightAll();</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-4918423-11"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('set', 'linker', {"domains":["www.andrearufo.it"]} );
    gtag('js', new Date());

    gtag("set", "developer_id.dZTNiMT", true);
    gtag('config', 'UA-4918423-11');
</script>

<!--

    returns the path to the current page, relative to the site root
    -> /articoli/2019/11/10/normalizzare-un-post-di-wordpress-con-i-suoi-meta


    returns the relative path (i.e. parent directories) of the current page, relative to the site root
    -> 


    returns the full URL to the item, if baseUrl was defined in config.php
    -> https://www.andrearufo.it/articoli/2019/11/10/normalizzare-un-post-di-wordpress-con-i-suoi-meta


    returns the filename of the page, without extension (e.g. my-first-page)
    -> normalizzare-un-post-di-wordpress-con-i-suoi-meta


    returns the file extension (e.g. md)
    -> md


    returns the last modified time of the file, as a Unix timestamp
    -> 1637575466

-->

</head>
<body>

    <header class="sticky-top py-2 border-bottom">
    <div class="container">

        <div class="row align-items-center justify-content-between">
            <div class="col-auto col-logo">

                <a href="/">
                    <i class="fak fa-ar fa-lg text-secondary"></i>
                </a>

            </div>
            <div class="col-auto col-hamburger text-end d-lg-flex d-none">

                <div id="desktopmenu">
                    <ul class="menu">
            <li class="menu-item">
            <a href="https://www.andrearufo.it/">
                Home
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/informazioni">
                Informazioni
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/curriculum">
                Curriculum
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/portfolio">
                Portfolio
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/articoli">
                Articoli
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/contattami">
                Contattami
            </a>
        </li>
    </ul>
                </div>

            </div>
            <div class="col-auto col-hamburger text-end d-lg-none d-flex">

                <button class="btn btn-link" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobilemenu" aria-controls="mobilemenu">
                    <i class="fal fa-bars fa-lg"></i>
                </button>

            </div>
        </div>

    </div>
</header>

<div class="offcanvas offcanvas-end" tabindex="-1" id="mobilemenu" aria-labelledby="mobilemenu">
    <div class="offcanvas-header">

        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>

    </div>
    <div class="offcanvas-body">

        <ul class="menu">
            <li class="menu-item">
            <a href="https://www.andrearufo.it/">
                Home
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/informazioni">
                Informazioni
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/curriculum">
                Curriculum
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/portfolio">
                Portfolio
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/articoli">
                Articoli
            </a>
        </li>
            <li class="menu-item">
            <a href="https://www.andrearufo.it/contattami">
                Contattami
            </a>
        </li>
    </ul>

    </div>
</div>

    <main class="py-3">
        <div class="container">

            <section class="normalizzare-un-post-di-wordpress-con-i-suoi-meta">

                <div class="row justify-content-center">
                    <div class="col-xl-8 col-lg-9">

                        <small class="text-muted">10 Nov 19</small>
                        <h1>Normalizzare un post di WordPress con i suoi meta</h1>

                    </div>
                </div>

                                    <div class="row justify-content-center">
                        <div class="col-xl-10 col-lg-10">

                            <div class="mb-5">
                                <img src="/assets/images/articoli/normalizza-custom-fields-wordpress.jpg" class="shadow rounded w-100" title="normalizza-custom-fields-wordpress.jpg">
                            </div>

                        </div>
                    </div>
                
                <div class="row justify-content-center">
                    <div class="col-xl-8 col-lg-9">

                        <h2>Torno a scrivere dopo un po' di tempo per condividere un codice che mi è stato davvero utile negli ultimi progetti.</h2>

<p>Alcuni siti hanno al loro interno "qualcosa" tipo un catalogo, o una varietà di informazioni molto, ma molto ampia. Wordpress agevola la gestione di questi contenuti attraverso la creazione di <a href="https://wordpress.org/support/article/post-types/">custom post type</a> a cui si possono legare dei <a href="https://wordpress.org/support/article/custom-fields/">custom fields</a>. Questo vuol dire che con uno sforzo molto basso puoi creare una collezione di oggetti e per ognuno di essi puoi avere informazioni peculiari. E puoi creare pagine di archivi, ricerche e tanto altro.</p>

<h3>TL;NR</h3>

<p>Ok... questo fino a quando non cominciano a diventare centinaia o migliaia o decine di migliaia di custom fileds da ricercare e comparare. A questo punto il classico <a href="https://developer.wordpress.org/reference/classes/wp_query/">WP_Query</a> non è una via percorribile. Il problema principale è ovviamente i tempi di risposta del server ed eventualmente la potenza di calcolo a disposizione.</p>

<h3>La soluzione</h3>

<p>La maniera più efficace che si ha a disposizione l'interrogazione diretta del database MySQL e normalizzare il dato: ovvero avere, per ogni singolo oggetto della collezione, tutti i field necessari direttamente dal database. E questo attraverso un'unica interrogazione!</p>

<h2>Il funzionamento standard</h2>

<p>Questa parte è noiosa: vi avverto!</p>

<p>Di standard Wordpress utilizza un oggetto PHP <em>Post</em>. I Post vengono salvati nella tabella del database <code>wp_posts</code> (dove <code>wp_</code> è il prefisso della tabella e può cambiare per ogni installazione o a piacimento). Per ogni Post vengono salvati innumerevoli alti dati nella tabella <code>wp_postmeta</code> collegandoli al post tramite l'id dello stesso.</p>

<p>Succede che ovviamente incrociando i dati di queste due tabelle è possibile avere una riposta molto più veloce rispetto alla chiamata singola del post e una altra per ogni postmeta necessario.</p>

<h2>La funzione di normalizzazione Ed ecco la funzione completa:</h2>

<script src="https://gist.github.com/andrearufo/e036bb8afbede846d8cc5cf5c903a439.js"></script>

<h4>La versione breve: come usarla</h4>

<p>La funzione ritorna un array di oggetti (oggetti standard di PHP, non oggetti di tipo <em>Post</em>).</p>

<p>Il primo parametro <code>$type</code> è il tipo di post che si intende richiamare. È stato scelto nella creazione del custom post che vi interessa: se non lo ricordate potete andare nella sezione del backend e leggere dalla url qualcosa tipo <code>wp-admin/edit.php?post_type=lavoro</code> e allora dovete scrivere <code>lavoro</code>.</p>

<p>Il secondo parametro è un array di tutti i meta che volete richiedere: anche di questi dovete conoscere il nome. Se li avete creati con <em>Advanced Custom Fields</em> non vi sarà complicato andare a trovarli, altrimenti dovete ingegnarvi un po' e vedere nelle schermate o nel database. Ogni oggetto ottenuto dalla chiamata riporta:</p>

<ul>
<li>ID;</li>
<li>titolo;</li>
<li>field richiesti.</li>
</ul>

<p>Quindi ora, avendo un elenco completo di tutti i dati che vi sono necessari potete manovrarli più agevolmente in PHP.</p>

<h4>La versione lunga: come funziona</h4>

<p>Il tutto avviene abbastanza banalmente tramite la creazione di una query per MySQL e la relativa chiamata. Il tutto è reso più agnostico e facile grazie all'uso di un oggetto globale <code>$wpdb</code> messo a disposizione da Wordpress con una serie di metodi utili per interfacciarci col database MySQL.</p>

<p>In un esempio dove vogliamo ottenere tutti i post di tipo <code>portfolio</code> e i relativi meta <code>year</code>, <code>customer</code>, <code>place</code>, <code>link</code> e <code>price</code> la query che ne viene fuori sarà del tipo:</p>

<pre><code class="language-sql">SELECT 
    ID, 
    post_title as title, 
    MAX(CASE WHEN pm.meta_key = 'year' THEN pm.meta_value END ) AS year , 
    MAX( CASE WHEN pm.meta_key = 'customer' THEN pm.meta_value END ) AS customer , 
    MAX( CASE WHEN pm.meta_key = 'place' THEN pm.meta_value END ) AS place , 
    MAX( CASE WHEN pm.meta_key = 'link' THEN pm.meta_value END ) AS link , 
    MAX( CASE WHEN pm.meta_key = 'price' THEN pm.meta_value END ) AS price 
FROM 
    wp_postmeta pm 
LEFT JOIN 
    wp_posts p 
ON 
    p.ID = pm.post_id 
WHERE 
    ( 
        pm.meta_key = 'year' 
        OR pm.meta_key = 'customer' 
        OR pm.meta_key = 'place' 
        OR pm.meta_key = 'link' 
        OR pm.meta_key = 'price' 
    ) 
    AND pm.meta_value IS NOT NULL 
    AND p.post_status = 'publish' 
    AND p.post_type = 'portfolio' 
GROUP BY 
    pm.post_id
</code></pre>

<p>Una cosa interessante: prima della chiamata al database ovviamente crea una query MySQL che, a parer mio, è molto interessante e, volendo, può essere integrata per degli utilizzi diversi e più specifici.</p>

<hr />

<p>Spero la cosa possa esservi utile e, nel caso aveste dubbi, contattatemi pure! Al link del <a href="https://gist.github.com/andrearufo/e036bb8afbede846d8cc5cf5c903a439">Gist su GitHub</a> trovate il codice che vedete sopra e potete commentare, forkare e quanto altro.</p>

                    </div>
                </div>

            </section>

        </div>
    </main>

    <footer id="footer" class="py-3 border-top">
    <div class="container">

        <div class="row justify-content-between">
            <div class="col-lg-5 col-xl-4">

                <div class="footer-item">
                    <div class="footer-item-title">
                        Contatti
                    </div>
                    <div class="footer-item-content">
                        <ul>
                            <li><a target="_blank" href="mailto:a.rufo@axio.studio">a.rufo@axio.studio</a></li>
                            <li><a target="_blank" href="tel:+393386213493">+39 338 62 13 493</a></li>
                        </ul>
                    </div>

                    <div class="footer-item-title mt-3">
                        Socials
                    </div>
                    <div class="footer-item-content">
                        <ul>
                                                            <li>
                                    <a target="_blank" href="https://twitter.com/@andrearufo">twitter</a>
                                </li>
                                                            <li>
                                    <a target="_blank" href="https://www.linkedin.com/in/andrearufo/">linkedin</a>
                                </li>
                                                            <li>
                                    <a target="_blank" href="https://www.instagram.com/andrearufo/">instagram</a>
                                </li>
                                                            <li>
                                    <a target="_blank" href="https://github.com/andrearufo">github</a>
                                </li>
                                                            <li>
                                    <a target="_blank" href="https://www.youtube.com/c/andrearufo">youtube</a>
                                </li>
                                                            <li>
                                    <a target="_blank" href="https://andrearufo.substack.com/">substack</a>
                                </li>
                                                    </ul>
                    </div>
                </div>

            </div>
            <div class="col-lg text-lg-right">

                <div class="footer-item">
                    <div class="footer-item-content">
                        <a href="https://www.iubenda.com/privacy-policy/867456" class="iubenda-black iubenda-embed" title="Privacy Policy ">Privacy Policy</a>
                        <script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src="https://cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
                    </div>

                    <div class="footer-item-content">
                        Tutti i marchi riportati appartengono ai legittimi proprietari; marchi di terzi, nomi di prodotti, nomi commerciali, nomi corporativi e società citati possono essere marchi di proprietà dei rispettivi titolari o marchi registrati d’altre società e vengono utilizzati a puro scopo esplicativo ed a beneficio del possessore, senza alcun fine di violazione dei diritti di Copyright vigenti.
                    </div>

                    <div class="footer-item-content mt-1">
                        <div class="text-muted">
                            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" class="text-decoration-none">
                                <i class="fab fa-creative-commons"></i>
                                <i class="fab fa-creative-commons-by"></i>
                                <i class="fab fa-creative-commons-nc-eu"></i>
                                <i class="fab fa-creative-commons-sa"></i>
                                4.0 2021
                            </a>
                            <span class="px-1">©</span>
                            Andrea Rufo
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <div id="cookie">
        <div id="cookie-wrapper">
            <div id="cookie-content">
                <i class="fad fa-cookie-bite me-2"></i>
                Questo sito <em>potrebbe</em> usare i cookie
            </div>
            <button id="cookie-ok">Ok</button>
        </div>
    </div>
</footer>

<script defer src="/assets/build/js/main.js?id=187894797f781e740678"></script>
<script defer src="https://kit.fontawesome.com/7319c752cd.js"></script>

</body>
</html>
